<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>k8s+gitea+jenkinsæ­å»ºCIç¯å¢ƒ | è‚–é’å±±çš„åšå®¢</title><meta name=keywords content="jenkins,gitea,k8s"><meta name=description content="è®°å½•ä¸€ä¸‹åˆ©ç”¨ Gitea å­˜å‚¨ä»£ç ã€Jenkins è¿›è¡ŒæŒç»­é›†æˆ (CI)ï¼Œå¹¶åœ¨ Kubernetes (K8s) ä¸­æ‹‰å–å®¹å™¨ç¼–è¯‘ä»£ç çš„ CI/CD æµç¨‹ã€‚
1. ç¯å¢ƒæ­å»º
ç¯å¢ƒæ­å»ºåŒ…æ‹¬giteaéƒ¨ç½²ï¼Œjenkinséƒ¨ç½²å’Œk8séƒ¨ç½²ã€‚"><meta name=author content="è‚–é’å±±"><link rel=canonical href=https://qingshanxiao292311.github.io/zh/posts/deploy/k8s+gitea+jenkins%E6%90%AD%E5%BB%BAci%E7%8E%AF%E5%A2%83/><link crossorigin=anonymous href=/assets/css/stylesheet.559c67081f8f21fd1632ee7c58054e89b75e8392806e32d058737904df031449.css integrity="sha256-VZxnCB+PIf0WMu58WAVOibdeg5KAbjLQWHN5BN8DFEk=" rel="preload stylesheet" as=style><link rel=icon href=https://qingshanxiao292311.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://qingshanxiao292311.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://qingshanxiao292311.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://qingshanxiao292311.github.io/apple-touch-icon.png><link rel=mask-icon href=https://qingshanxiao292311.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://qingshanxiao292311.github.io/zh/posts/deploy/k8s+gitea+jenkins%E6%90%AD%E5%BB%BAci%E7%8E%AF%E5%A2%83/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel=stylesheet><meta property="og:url" content="https://qingshanxiao292311.github.io/zh/posts/deploy/k8s+gitea+jenkins%E6%90%AD%E5%BB%BAci%E7%8E%AF%E5%A2%83/"><meta property="og:site_name" content="è‚–é’å±±çš„åšå®¢"><meta property="og:title" content="k8s+gitea+jenkinsæ­å»ºCIç¯å¢ƒ"><meta property="og:description" content="è®°å½•ä¸€ä¸‹åˆ©ç”¨ Gitea å­˜å‚¨ä»£ç ã€Jenkins è¿›è¡ŒæŒç»­é›†æˆ (CI)ï¼Œå¹¶åœ¨ Kubernetes (K8s) ä¸­æ‹‰å–å®¹å™¨ç¼–è¯‘ä»£ç çš„ CI/CD æµç¨‹ã€‚
1. ç¯å¢ƒæ­å»º ç¯å¢ƒæ­å»ºåŒ…æ‹¬giteaéƒ¨ç½²ï¼Œjenkinséƒ¨ç½²å’Œk8séƒ¨ç½²ã€‚"><meta property="og:locale" content="zh-cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-04-12T00:00:00+00:00"><meta property="article:modified_time" content="2025-06-23T00:00:00+00:00"><meta property="article:tag" content="Jenkins"><meta property="article:tag" content="Gitea"><meta property="article:tag" content="K8s"><meta name=twitter:card content="summary"><meta name=twitter:title content="k8s+gitea+jenkinsæ­å»ºCIç¯å¢ƒ"><meta name=twitter:description content="è®°å½•ä¸€ä¸‹åˆ©ç”¨ Gitea å­˜å‚¨ä»£ç ã€Jenkins è¿›è¡ŒæŒç»­é›†æˆ (CI)ï¼Œå¹¶åœ¨ Kubernetes (K8s) ä¸­æ‹‰å–å®¹å™¨ç¼–è¯‘ä»£ç çš„ CI/CD æµç¨‹ã€‚
1. ç¯å¢ƒæ­å»º
ç¯å¢ƒæ­å»ºåŒ…æ‹¬giteaéƒ¨ç½²ï¼Œjenkinséƒ¨ç½²å’Œk8séƒ¨ç½²ã€‚"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://qingshanxiao292311.github.io/zh/posts/"},{"@type":"ListItem","position":2,"name":"k8s+gitea+jenkinsæ­å»ºCIç¯å¢ƒ","item":"https://qingshanxiao292311.github.io/zh/posts/deploy/k8s+gitea+jenkins%E6%90%AD%E5%BB%BAci%E7%8E%AF%E5%A2%83/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"k8s+gitea+jenkinsæ­å»ºCIç¯å¢ƒ","name":"k8s\u002bgitea\u002bjenkinsæ­å»ºCIç¯å¢ƒ","description":"è®°å½•ä¸€ä¸‹åˆ©ç”¨ Gitea å­˜å‚¨ä»£ç ã€Jenkins è¿›è¡ŒæŒç»­é›†æˆ (CI)ï¼Œå¹¶åœ¨ Kubernetes (K8s) ä¸­æ‹‰å–å®¹å™¨ç¼–è¯‘ä»£ç çš„ CI/CD æµç¨‹ã€‚\n1. ç¯å¢ƒæ­å»º ç¯å¢ƒæ­å»ºåŒ…æ‹¬giteaéƒ¨ç½²ï¼Œjenkinséƒ¨ç½²å’Œk8séƒ¨ç½²ã€‚\n","keywords":["jenkins","gitea","k8s"],"articleBody":"è®°å½•ä¸€ä¸‹åˆ©ç”¨ Gitea å­˜å‚¨ä»£ç ã€Jenkins è¿›è¡ŒæŒç»­é›†æˆ (CI)ï¼Œå¹¶åœ¨ Kubernetes (K8s) ä¸­æ‹‰å–å®¹å™¨ç¼–è¯‘ä»£ç çš„ CI/CD æµç¨‹ã€‚\n1. ç¯å¢ƒæ­å»º ç¯å¢ƒæ­å»ºåŒ…æ‹¬giteaéƒ¨ç½²ï¼Œjenkinséƒ¨ç½²å’Œk8séƒ¨ç½²ã€‚\n1.1 gitea éƒ¨ç½² giteaéƒ¨ç½²\n1.2 jenkins éƒ¨ç½² jenkinséƒ¨ç½²\n1.3 k8séƒ¨ç½² k8s masterèŠ‚ç‚¹éƒ¨ç½²\nk8s nodeèŠ‚ç‚¹éƒ¨ç½²\nk8s ç½‘ç»œæ’ä»¶éƒ¨ç½²\n2. Gitea é…ç½® 2.1 organization ä½¿ç”¨ç®¡ç†å‘˜ç™»å½•Gitea ç®¡ç†å¹³å°\næ·»åŠ ä¸€ä¸ªorganization\nç»™ç»„ç»‡è®¾ç½®webhook\nâ€‹ Target URLè®¾ç½®ï¼š ä¾‹å¦‚http://10.0.0.190:8000/gitea-webhook/postï¼Œ 10.0.0.190æ˜¯jenkinsæœåŠ¡æ‰€åœ¨çš„ä¸»æœºIPï¼Œ 8000æ˜¯jenkinsæœåŠ¡ç«¯å£\nè®¾ç½®Trigger â€‹ è®¾ç½® pull request\nâ€‹ ç‚¹å‡» Update Webhookæ›´æ–°è®¾ç½®\n2.2 repository æ–°å»ºrepository\nè®¾ç½®webhook\nrepository çš„webhookè®¾ç½®ä¸organizationçš„webhookå®Œå…¨ä¸€è‡´ã€‚\næ£€æŸ¥ä»“åº“webhookè”é€šæ€§\næ³¨æ„ï¼šè¿™æ­¥éœ€è¦åœ¨Jenkinsè®¾ç½®å¥½åæ‰å¯ä»¥éªŒè¯ã€‚\nç‚¹å‡» Test Deliveryï¼Œå¯ä»¥æµ‹è¯•Giteaåˆ°JenkinsæœåŠ¡æ˜¯å¦è¿é€šï¼Œæ³¨æ„éœ€è¦å…ˆå¯åŠ¨JenkinsæœåŠ¡ã€‚\nâ€œçº¢è‰²æ„Ÿå¹å·\"ä»£è¡¨ä¸é€šï¼šæ²¡æœ‰å“åº”\n1 Delivery: Post \"http://10.0.0.190:8000/gitea-webhook/post\": dial tcp 10.0.0.190:8000: webhook can only call allowed HTTP servers (check your webhook.ALLOWED_HOST_LIST setting), deny '10.0.0.190(10.0.0.190:8000)'\t2.3 ä¿®æ”¹é…ç½®æ–‡ä»¶ ä¿®æ”¹Giteaé…ç½®æ–‡ä»¶app.iniï¼Œæ·»åŠ å¦‚ä¸‹å†…å®¹ï¼Œå¯ä»¥ä¿®å¤2.2å°èŠ‚çš„æ­¥éª¤3å‡ºç°çš„é—®é¢˜ã€‚\n1 2 [webhook] ALLOWED_HOST_LIST = *æˆ–10.0.0.190 2.4 ç”Ÿæˆ Token è¿™ä¸ªtokenç”¨äºJenkinså¯ä»¥é€šè¿‡å®‰è£…çš„Giteaæ’ä»¶è®¿é—®Giteaï¼Œæ‰«æå’Œæ‹‰å–ä»£ç ã€‚\nç‚¹å‡»å³ä¸Šè§’ç”¨æˆ·ï¼š\nè®¾ç½®tokenåï¼Œè®¾ç½®ç›¸åº”çš„readæˆ–read/writeæƒé™ï¼Œç‚¹å‡»Generate Tokenå³å¯äº§ç”ŸTokenï¼Œå¤åˆ¶ä¸‹è¿™ä¸ªTokenï¼Œéœ€è¦æ”¾åˆ°Jenkinsçš„Cerdentialsä¸­å»ã€‚\n3. Jenkins è®¾ç½® 3.1 Install Plugin ç”±äºéœ€è¦ä»giteaæ‹‰å–ä»£ç ï¼Œå¹¶åˆ©ç”¨k8sæ‹‰å–é•œåƒç¼–è¯‘ä»£ç ï¼Œæ‰€ä»¥éœ€è¦å®‰è£…å¿…è¦çš„æ’ä»¶ã€‚å®‰è£… Kubernetesï¼ŒGitea.\nåœ¨Available plugins ä¸­æœç´¢éœ€è¦å®‰è£…çš„æ’ä»¶ï¼Œç‚¹å‡»å³ä¸Šè§’çš„\"Installâ€ å³å¯å®‰è£…ã€‚\nå®‰è£…å¥½ååœ¨Install pluginså¯ä»¥æŸ¥çœ‹ï¼š\n3.2 System Configuration ç‚¹å‡» Manage Jenkins-\u003eSystem Configuration-\u003esystem:\nGitea Server æ·»åŠ è®¿é—®Giteaé¡µé¢çš„URLï¼Œæ·»åŠ åä¼šæ­£ç¡®æ˜¾ç¤ºGiteaçš„ç‰ˆæœ¬ã€‚è¿™ä¸ªGiteaç‰ˆæœ¬å°±æ˜¯1.24.0ã€‚\nè®¾ç½®åä¿å­˜å³å¯ã€‚\n3.3 Add Cerdentials æ·»åŠ è¯ä¹¦ç”¨äºè®¿é—®Giteaå’ŒKubernetesã€‚\n3.3.1 æ·»åŠ Gitea Credential ç‚¹å‡» Manage Jenkins-\u003eCerdentialsã€‚\næ·»åŠ è®¿é—®Giteaçš„Credentialsï¼š\nKindé€‰æ‹©Gitea Personal Access Tokenï¼ŒTokenè¾“å…¥2.4å°èŠ‚ä¿å­˜çš„Tokenï¼ŒIDå’ŒDescription è‡ªå®šä¹‰ã€‚\n3.3.2 æ·»åŠ  Kubernetes Credential æ·»åŠ Kubernetes Credentialä¸æ·»åŠ Gitea Credentialæ­¥éª¤ä¸€æ ·ï¼Œåªæ˜¯åœ¨Kindé€‰æ‹©æ—¶æœ‰æ‰€ä¸åŒï¼š\nKind å¯ä»¥é€‰æ‹©Screct fileï¼Œè¿™æ˜¯åªéœ€è¦æ·»åŠ k8sçš„configæ–‡ä»¶å³å¯ã€‚æœ¬æ–‡éƒ¨ç½²çš„k8sçš„ configé…ç½®æ–‡ä»¶è·¯å¾„åœ¨masterèŠ‚ç‚¹çš„~/.kube/ä¸‹ã€‚ Kind å¯ä»¥é€‰æ‹©Screct textï¼Œæœ¬æ–‡é‡‡ç”¨çš„è¿™ç§æ–¹å¼ã€‚\nè¿™ç§æ–¹å¼éœ€è¦å…ˆè·å–K8sçš„Tokenï¼Œk8såœ¨1.24+ç‰ˆæœ¬ä¹‹åéœ€è¦æ‰‹åŠ¨ç”ŸæˆTokenï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š\n1 2 3 4 5 6 7 8 9 åˆ›å»ºå‘½åç©ºé—´devopsï¼š kubectl create ns devops; åˆ›å»ºæœåŠ¡è´¦å·jenkins: kubectl create sa jenkins -n devops #åˆ›å»ºæœåŠ¡è´¦å·jenkinså±äºå‘½åç©ºé—´devops, saæ˜¯serviceaccountsçš„ç¼©å†™ ç»‘å®šé›†ç¾¤è§’è‰²ï¼š kubectl create clusterrolebinding jenkins --clusterrole=cluster-admin --serviceaccount=devops:jenkins k8s 1.24+ä¹‹åæ‰‹åŠ¨ç”Ÿæˆtoken: kubectl create token jenkins --duration=8760h # æœ‰æ•ˆæœŸ 1 å¹´ å¤åˆ¶kubectl create äº§ç”Ÿçš„Tokenã€‚\næ·»åŠ å®Œæˆåå¯ä»¥çœ‹åˆ°ï¼š\n3.4 Add Clouds é…ç½®Jenkinsé€šè¿‡Kubernetesæ’ä»¶ä¸Kubernetesè¿æ¥ã€‚\n3.4.1 New cloud ç‚¹å‡» Manage Jenkins â€”\u003e Cloudsâ€“\u003eNew cloud.\nè¾“å…¥cloud nameï¼ŒTypeé€‰æ‹©Kubernetesï¼Œç‚¹å‡»Createã€‚\n3.4.2 Cloud Configure åç§°: ç»§æ‰¿ä¸Šä¸ªæ­¥éª¤è¾“å…¥çš„ï¼› Kubernetesåœ°å€: Kubernetesé›†ç¾¤kube-apiserveræ‰€åœ¨èŠ‚ç‚¹çš„IPå’Œç«¯å£ï¼Œå¦‚æœåœ°å€ä¸é€šä¼šæœ‰æç¤ºï¼› ç¦ç”¨httpsæ£€æŸ¥ï¼› Kubernetes å‘½ä»¤ç©ºé—´ï¼šè¾“å…¥3.3.2æ­¥éª¤åˆ›å»ºçš„ å‡­æ®ï¼šé€‰æ‹©3.3.2æ­¥éª¤æ·»åŠ çš„k8s credentialsï¼› å‹¾é€‰websocketï¼› Jenkinsåœ°å€ï¼šå¡«å†™JenkinsæœåŠ¡çš„ä¸»æœºIPä¸æœåŠ¡ç«¯å£å·ã€‚ Pod Lable: æ ‡ç­¾è‡ªå®šä¹‰ä¸€ä¸ªï¼Œåç»­åœ¨Podçš„yamlæ–‡ä»¶ä¸­èƒ½çœ‹åˆ°è¿™ä¸ªã€‚ Pod Retetionï¼šPod ä¿ç•™ç­–ç•¥ï¼Œalwaysæ˜¯æ°¸ä¹…ä¿å­˜ã€‚ å…¶ä»–é»˜è®¤ï¼Œæœ€åç‚¹å‡»ä¿å­˜å³å¯ã€‚\n4 ä¸Šä¼ ä»£ç åˆ°Gitea 4.1 ç¼–å†™Jenkinsfileæ–‡ä»¶ åŸºäºJenkins Kubernetesæ’ä»¶çš„podTemplateç¼–å†™Jenkinsfileæ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 podTemplate( podRetention: always(), containers: [ containerTemplate( name: 'c-builder-env1', image: 'registry.example.com/c-builder-env1:latest', // æ›¿æ¢ä¸ºä½ çš„ç§æœ‰é•œåƒåœ°å€ ttyEnabled: true, command: 'cat', imagePullSecrets: 'docker-registry-credentials' // Jenkinsä¸­é…ç½®çš„Kubernetes Secretåç§° ), ] ) { node(POD_LABEL) { stage('Checkout') { checkout scm // ä¾èµ–Jenkinsä»»åŠ¡é…ç½®çš„SCMï¼Œæ£€å‡ºä»£ç  } stage('Build in env1') { container('c-builder-env1') { withEnv(['PATH+EXTRA=/opt/build-tools']) { // æ›¿æ¢ä¸ºä½ çš„å·¥å…·è·¯å¾„ sh '''#!/bin/bash set -exo pipefail chmod +x ./build.sh bash ./build.sh ''' } } } stage('Test') { container('c-builder-env1') { // ç¤ºä¾‹ï¼šä½¿ç”¨env1è¿è¡Œæµ‹è¯• withEnv(['PATH+EXTRA=/opt/build-tools']) { sh '''#!/bin/bash set -exo pipefail // æ›¿æ¢ä¸ºä½ çš„æµ‹è¯•å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š bash ./run-tests.sh // å‡è®¾æœ‰æµ‹è¯•è„šæœ¬ ''' } } } } } 4.2 ä¸Šä¼ æºä»£ç  å°†Jenkinsfileæ–‡ä»¶å’Œæºä»£ç ä¸Šä¼ åˆ° Gitea ä»“åº“ã€‚è¿™ä¸ªå¾ˆé‡è¦ï¼Œå› ä¸ºJenkinsæ˜¯æ ¹æ®Jenkinsfileæ–‡ä»¶æ¥è¿›è¡Œæµæ°´çº¿ä½œä¸šçš„ã€‚å¹¶ä¸”è¿™ä¸ªJenkinsfileæ–‡ä»¶è¦æ”¾åœ¨æºä»£ç çš„æ ¹ç›®å½•ä¸‹ã€‚\n5 Jenkins New Item 5.1 æ–°å»º Organization Folder Item name: è¾“å…¥Gitea ä¸Šçš„organizationåï¼Œå¤§å°å†™å¿…é¡»ä¸€è‡´ï¼› é€‰æ‹©Organization Folder 5.2 configure å¯¹æ–°å»ºçš„ç»„ç»‡æ–‡ä»¶å¤¹è¿›è¡Œé…ç½®ã€‚\nDisplay Name: è®¾ç½®çš„organizationåï¼› Repository Sources: é€‰æ‹© Gitea Organizationï¼Œå¹¶é…ç½®Server å’Œ Credentials Owner: å¿…é¡»ä¸ Giteaçš„Organization ä¸€è‡´ã€‚ è¿™å°±æ˜¯ä¸Šæ–‡è¦æ·»åŠ Jenkinsfileçš„åŸå› ï¼Œä¸ç„¶Jenkinsæ‰«æä¸åˆ°ç»„ç»‡ä¸‹çš„ä»“åº“ã€‚\nç‚¹å‡»ä¿å­˜å³è®¾ç½®å®Œæˆã€‚\n6. è§¦å‘Jenkins æ‰‹åŠ¨è§¦å‘ è‡ªåŠ¨è§¦å‘\nå¯¹Giteaç»„ç»‡ä¸‹ä»“åº“çš„webhookè®¾ç½®è§¦å‘æ¡ä»¶ï¼ˆ2.1å°èŠ‚ï¼‰ï¼Œpull request å°±ä¼šè‡ªåŠ¨è§¦å‘Jenkinsè°ƒç”¨k8såˆ›å»ºPODç¼–è¯‘ã€‚\nç‚¹å‡»æŸæ¬¡ç¼–è¯‘çš„Console Outputï¼Œå¯ä»¥çœ‹åˆ°è¯¦ç»†çš„ç¼–è¯‘è¿‡ç¨‹\nk8sä¸Šè‡ªåŠ¨åˆ›å»ºçš„POD\nè¿›å…¥å®¹å™¨çš„/home/jenkins/agent/workspace/xxxä¸‹ï¼Œå³å¯çœ‹åˆ°æºä»£ç ã€‚\nâ€‹\n7. æ­å»ºè¿‡ç¨‹é‡åˆ°çš„é—®é¢˜ é—®é¢˜1ï¼šæ²¡æœ‰è‡ªåŠ¨è§¦å‘Jenkins ä»Giteaä¸Špull request åˆ†æ”¯ä»£ç åˆ°ä¸»åˆ†æ”¯ï¼Œæ²¡æœ‰æˆåŠŸè§¦å‘Jenkinsã€‚è¿™å°±æ˜¯2.2å°èŠ‚ç¬¬3æ­¥çš„é—®é¢˜ï¼Œé€šè¿‡2.3è§£å†³ã€‚\né—®é¢˜2ï¼šé•œåƒæ‹‰å–å¤±è´¥ ç°è±¡ï¼š\nä»æœ¬åœ°é•œåƒä»“åº“æ‹‰å–spice-vdagent-ks10-builder:v1.5.1é•œåƒå¤±è´¥ï¼Œé…ç½®çš„æœ¬åœ°ç§æœ‰é•œåƒä»“åº“åœ°å€æ˜¯http://xxxxï¼Œä½†æ˜¯å´ä»https://xxxæ‹‰å–ï¼› jenkins/inbound-agent:3309.v27b_9314fd1a_4-1é•œåƒæ‹‰å–å¤±è´¥ï¼› è¿™æ˜¯k8sçš„å®¹å™¨è¿è¡Œæ—¶containerd æ‹‰å–é•œåƒçš„åœ°å€è®¾ç½®ä¸å¯¹å¯¼è‡´ã€‚\n1 2 3 [PodInfo] devops/spice-vd-agent-master-3-jg7c8-6hq6d-6fh7s Container [jnlp] waiting [ErrImagePull] failed to pull and unpack image \"oci.docker.com/jenkins/inbound-agent:3309.v27b_9314fd1a_4-1\": failed to resolve reference \"oci.docker.com/jenkins/inbound-agent:3309.v27b_9314fd1a_4-1\": failed to do request: Head \"https://oci.docker.com/v2/jenkins/inbound-agent/manifests/3309.v27b_9314fd1a_4-1\": dial tcp 192.168.1.71:443: connect: connection refused Container [spice-vdagent-ks10-builder] waiting [ErrImagePull] failed to pull and unpack image \"oci.docker.com/spice-vdagent-ks10-builder:v1.5.1\": failed to resolve reference \"oci.docker.com/spice-vdagent-ks10-builder:v1.5.1\": failed to do request: Head \"https://oci.docker.com/v2/spice-vdagent-ks10-builder/manifests/v1.5.1\": dial tcp 192.168.1.71:443: connect: connection refused ä½¿ç”¨çš„containerdæ˜¯v2.0.0ç‰ˆæœ¬ã€‚\nè§£å†³åŠæ³•ï¼š\nä¿®æ”¹containerdçš„é…ç½®æ–‡ä»¶config.tomlã€‚é»˜è®¤ç›®å½•æ˜¯/etc/containerd/ï¼Œæ·»åŠ config_path = â€œxxxâ€ï¼Œæ³¨æ„æœ€åä¸€çº§ç›®å½• 1 2 [plugins.'io.containerd.cri.v1.images'.registry] config_path = '/etc/containerd/certs.d' æ–°å»ºæ–‡ä»¶ /etc/containerd/certs.d/oci.docker.com/hosts.toml\nä¿®æ”¹hosts.toml\n1 2 3 4 5 6 7 # å®šä¹‰æœåŠ¡å™¨çš„åŸºåœ°å€ server = \"http://oci.docker.com\" [host.\"http://oci.docker.com\"] # å¦‚æœä»“åº“æ˜¯ HTTP æˆ–ä½¿ç”¨è‡ªç­¾åè¯ä¹¦ï¼Œéœ€è¦è®¾ç½®è¿™ä¸ª skip_verify = true capabilities = [\"pull\", \"resolve\"] ç”±äºæœ¬åœ°é•œåƒä»“åº“æ²¡æœ‰ä¸Šä¼  inbound-agent:3309.v27b_9314fd1a_4-1é•œåƒï¼Œæ‰€ä»¥æ‹‰å–å¤±è´¥ï¼Œé…ç½®å›½å†…æºè§£å†³\næ–°å»ºæ–‡ä»¶ /etc/containerd/certs.d/docker.io/hosts.toml\n1 2 3 4 5 6 server = \"https://docker.xuanyuan.me\" # ä¸º docker.io é…ç½®é•œåƒåŠ é€Ÿå™¨ (mirrors) [host.\"https://docker.xuanyuan.me\"] capabilities = [\"pull\", \"resolve\"] override_path = false # è¿™ä¸ªå¾ˆé‡è¦ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªé•œåƒè€Œä¸æ˜¯è·¯å¾„è¦†ç›– é‡å¯containerdå®¹å™¨ã€‚\nè‡³æ­¤æ­å»ºå’Œæµ‹è¯•å®Œæˆï¼\n","wordCount":"3267","inLanguage":"zh","datePublished":"2025-04-12T00:00:00Z","dateModified":"2025-06-23T00:00:00Z","author":{"@type":"Person","name":"è‚–é’å±±"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://qingshanxiao292311.github.io/zh/posts/deploy/k8s+gitea+jenkins%E6%90%AD%E5%BB%BAci%E7%8E%AF%E5%A2%83/"},"publisher":{"@type":"Organization","name":"è‚–é’å±±çš„åšå®¢","logo":{"@type":"ImageObject","url":"https://qingshanxiao292311.github.io/favicon.ico"}}}</script><script src=https://qingshanxiao292311.github.io/js/custom.min.c93f92fa01d87c7adadd838df0adbf3fc94df38ab17741f7adf8fde077ddef22.js integrity="sha256-yT+S+gHYfHra3YON8K2/P8lN84qxd0H3rfj94Hfd7yI=" defer></script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://qingshanxiao292311.github.io/zh/ accesskey=h title="è‚–é’å±±çš„åšå®¢ (Alt + H)">è‚–é’å±±çš„åšå®¢</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li><li><a href=https://qingshanxiao292311.github.io/en/ title=English aria-label=English>English</a></li></ul></div></div><ul id=menu><li><a href=https://qingshanxiao292311.github.io/zh/ title="ğŸ  ä¸»é¡µ"><span>ğŸ  ä¸»é¡µ</span></a></li><li><a href=https://qingshanxiao292311.github.io/zh/search/ title="ğŸ” æœç´¢ (Alt + /)" accesskey=/><span>ğŸ” æœç´¢</span></a></li><li><a href=https://qingshanxiao292311.github.io/zh/archives/ title="â± æ—¶é—´è½´"><span>â± æ—¶é—´è½´</span></a></li><li><a href=https://qingshanxiao292311.github.io/zh/categories/ title="ğŸ“ åˆ†ç±»"><span>ğŸ“ åˆ†ç±»</span></a></li><li><a href=https://qingshanxiao292311.github.io/zh/tags/ title="ğŸ·ï¸ æ ‡ç­¾"><span>ğŸ·ï¸ æ ‡ç­¾</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://qingshanxiao292311.github.io/zh/>ä¸»é¡µ</a>&nbsp;Â»&nbsp;<a href=https://qingshanxiao292311.github.io/zh/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">k8s+gitea+jenkinsæ­å»ºCIç¯å¢ƒ</h1><div class=post-meta><div class=post-meta><span class=post-meta-item><span class=icon>ğŸ“…</span>
åˆ›å»º: 2025-04-12
</span><span class=post-meta-item><span class=icon>ğŸ”„</span>
æ›´æ–°: 2025-06-23
</span><span class=post-meta-item><span class=icon>â³</span>
æ—¶é•¿: 7åˆ†é’Ÿ
</span><span class=post-meta-item><span class=icon>ğŸ“</span>
å­—æ•°: 3267å­—
</span><span class=post-meta-item><span class=icon>ğŸ‘¤</span>
è‚–é’å±±</span></div></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>ç›®å½•</span></summary><div class=inner><ul><li><a href=#1-%e7%8e%af%e5%a2%83%e6%90%ad%e5%bb%ba aria-label="1. ç¯å¢ƒæ­å»º">1. ç¯å¢ƒæ­å»º</a><ul><li><a href=#11-gitea-%e9%83%a8%e7%bd%b2 aria-label="1.1 gitea éƒ¨ç½²">1.1 gitea éƒ¨ç½²</a></li><li><a href=#12-jenkins-%e9%83%a8%e7%bd%b2 aria-label="1.2 jenkins éƒ¨ç½²">1.2 jenkins éƒ¨ç½²</a></li><li><a href=#13-k8s%e9%83%a8%e7%bd%b2 aria-label="1.3 k8séƒ¨ç½²">1.3 k8séƒ¨ç½²</a></li></ul></li><li><a href=#2-gitea-%e9%85%8d%e7%bd%ae aria-label="2. Gitea é…ç½®">2. Gitea é…ç½®</a><ul><li><a href=#21-organization aria-label="2.1 organization">2.1 organization</a></li><li><a href=#22-repository aria-label="2.2 repository">2.2 repository</a></li><li><a href=#23-%e4%bf%ae%e6%94%b9%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6 aria-label="2.3 ä¿®æ”¹é…ç½®æ–‡ä»¶">2.3 ä¿®æ”¹é…ç½®æ–‡ä»¶</a></li><li><a href=#24-%e7%94%9f%e6%88%90-token aria-label="2.4 ç”Ÿæˆ Token">2.4 ç”Ÿæˆ Token</a></li></ul></li><li><a href=#3-jenkins-%e8%ae%be%e7%bd%ae aria-label="3. Jenkins è®¾ç½®">3. Jenkins è®¾ç½®</a><ul><li><a href=#31-install-plugin aria-label="3.1 Install Plugin">3.1 Install Plugin</a></li><li><a href=#32-system-configuration aria-label="3.2 System Configuration">3.2 System Configuration</a></li><li><a href=#33-add-cerdentials aria-label="3.3 Add Cerdentials">3.3 Add Cerdentials</a><ul><li><a href=#331-%e6%b7%bb%e5%8a%a0gitea-credential aria-label="3.3.1 æ·»åŠ Gitea Credential">3.3.1 æ·»åŠ Gitea Credential</a></li><li><a href=#332-%e6%b7%bb%e5%8a%a0-kubernetes-credential aria-label="3.3.2 æ·»åŠ  Kubernetes Credential">3.3.2 æ·»åŠ  Kubernetes Credential</a></li></ul></li><li><a href=#34--add-clouds aria-label="3.4  Add Clouds">3.4 Add Clouds</a><ul><li><a href=#341-new-cloud aria-label="3.4.1 New cloud">3.4.1 New cloud</a></li><li><a href=#342-cloud-configure aria-label="3.4.2 Cloud Configure">3.4.2 Cloud Configure</a></li></ul></li></ul></li><li><a href=#4-%e4%b8%8a%e4%bc%a0%e4%bb%a3%e7%a0%81%e5%88%b0gitea aria-label="4 ä¸Šä¼ ä»£ç åˆ°Gitea">4 ä¸Šä¼ ä»£ç åˆ°Gitea</a><ul><li><a href=#41-%e7%bc%96%e5%86%99jenkinsfile%e6%96%87%e4%bb%b6 aria-label="4.1 ç¼–å†™Jenkinsfileæ–‡ä»¶">4.1 ç¼–å†™Jenkinsfileæ–‡ä»¶</a></li><li><a href=#42-%e4%b8%8a%e4%bc%a0%e6%ba%90%e4%bb%a3%e7%a0%81 aria-label="4.2 ä¸Šä¼ æºä»£ç ">4.2 ä¸Šä¼ æºä»£ç </a></li></ul></li><li><a href=#5-jenkins-new-item aria-label="5 Jenkins New Item">5 Jenkins New Item</a><ul><li><a href=#51-%e6%96%b0%e5%bb%ba-organization-folder aria-label="5.1 æ–°å»º Organization Folder">5.1 æ–°å»º Organization Folder</a></li><li><a href=#52-configure aria-label="5.2 configure">5.2 configure</a></li></ul></li><li><a href=#6-%e8%a7%a6%e5%8f%91jenkins aria-label="6. è§¦å‘Jenkins">6. è§¦å‘Jenkins</a></li><li><a href=#7-%e6%90%ad%e5%bb%ba%e8%bf%87%e7%a8%8b%e9%81%87%e5%88%b0%e7%9a%84%e9%97%ae%e9%a2%98 aria-label="7. æ­å»ºè¿‡ç¨‹é‡åˆ°çš„é—®é¢˜">7. æ­å»ºè¿‡ç¨‹é‡åˆ°çš„é—®é¢˜</a><ul><li><a href=#%e9%97%ae%e9%a2%981%e6%b2%a1%e6%9c%89%e8%87%aa%e5%8a%a8%e8%a7%a6%e5%8f%91jenkins aria-label=é—®é¢˜1ï¼šæ²¡æœ‰è‡ªåŠ¨è§¦å‘Jenkins>é—®é¢˜1ï¼šæ²¡æœ‰è‡ªåŠ¨è§¦å‘Jenkins</a></li><li><a href=#%e9%97%ae%e9%a2%982%e9%95%9c%e5%83%8f%e6%8b%89%e5%8f%96%e5%a4%b1%e8%b4%a5 aria-label=é—®é¢˜2ï¼šé•œåƒæ‹‰å–å¤±è´¥>é—®é¢˜2ï¼šé•œåƒæ‹‰å–å¤±è´¥</a></li></ul></li></ul></div></details></div><div class=post-content><p>è®°å½•ä¸€ä¸‹åˆ©ç”¨ Gitea å­˜å‚¨ä»£ç ã€Jenkins è¿›è¡ŒæŒç»­é›†æˆ (CI)ï¼Œå¹¶åœ¨ Kubernetes (K8s) ä¸­æ‹‰å–å®¹å™¨ç¼–è¯‘ä»£ç çš„ CI/CD æµç¨‹ã€‚</p><h1 id=1-ç¯å¢ƒæ­å»º>1. ç¯å¢ƒæ­å»º<a hidden class=anchor aria-hidden=true href=#1-ç¯å¢ƒæ­å»º>#</a></h1><p>ç¯å¢ƒæ­å»ºåŒ…æ‹¬giteaéƒ¨ç½²ï¼Œjenkinséƒ¨ç½²å’Œk8séƒ¨ç½²ã€‚</p><h2 id=11-gitea-éƒ¨ç½²>1.1 gitea éƒ¨ç½²<a hidden class=anchor aria-hidden=true href=#11-gitea-éƒ¨ç½²>#</a></h2><p><a href=https://qingshanxiao292311.github.io/zh/posts/deploy/gitea-%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2/>giteaéƒ¨ç½²</a></p><h2 id=12-jenkins-éƒ¨ç½²>1.2 jenkins éƒ¨ç½²<a hidden class=anchor aria-hidden=true href=#12-jenkins-éƒ¨ç½²>#</a></h2><p><a href=https://qingshanxiao292311.github.io/zh/posts/deploy/jenkins-%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2/>jenkinséƒ¨ç½²</a></p><h2 id=13-k8séƒ¨ç½²>1.3 k8séƒ¨ç½²<a hidden class=anchor aria-hidden=true href=#13-k8séƒ¨ç½²>#</a></h2><p><a href="https://blog.csdn.net/qq_35721743/article/details/146638816?spm=1001.2014.3001.5501">k8s masterèŠ‚ç‚¹éƒ¨ç½²</a></p><p><a href="https://blog.csdn.net/qq_35721743/article/details/146965262?spm=1001.2014.3001.5501">k8s nodeèŠ‚ç‚¹éƒ¨ç½²</a></p><p><a href="https://blog.csdn.net/qq_35721743/article/details/146969984?spm=1001.2014.3001.5501">k8s ç½‘ç»œæ’ä»¶éƒ¨ç½²</a></p><h1 id=2-gitea-é…ç½®>2. Gitea é…ç½®<a hidden class=anchor aria-hidden=true href=#2-gitea-é…ç½®>#</a></h1><h2 id=21-organization>2.1 organization<a hidden class=anchor aria-hidden=true href=#21-organization>#</a></h2><ol><li><p>ä½¿ç”¨ç®¡ç†å‘˜ç™»å½•Gitea ç®¡ç†å¹³å°</p></li><li><p>æ·»åŠ ä¸€ä¸ªorganization</p><p><img alt="æ–°å»º organization" loading=lazy src=/images/ci/organization.png></p></li><li><p>ç»™ç»„ç»‡è®¾ç½®webhook</p><p><img alt="è®¾ç½® webhook" loading=lazy src=/images/ci/webhook.png></p></li></ol><p>â€‹ Target URLè®¾ç½®ï¼š ä¾‹å¦‚http://10.0.0.190:8000/gitea-webhook/postï¼Œ 10.0.0.190æ˜¯jenkinsæœåŠ¡æ‰€åœ¨çš„ä¸»æœºIPï¼Œ 8000æ˜¯jenkinsæœåŠ¡ç«¯å£</p><ol start=4><li>è®¾ç½®Trigger</li></ol><p>â€‹ <img alt=è®¾ç½®è§¦å‘é€‰é¡¹ loading=lazy src=/images/ci/trigger.png></p><ol start=5><li><p>è®¾ç½® pull request</p><p><img alt="è®¾ç½® pullrequest é€‰é¡¹" loading=lazy src=/images/ci/pull-request.png></p></li></ol><p>â€‹ ç‚¹å‡» Update Webhookæ›´æ–°è®¾ç½®</p><h2 id=22-repository>2.2 repository<a hidden class=anchor aria-hidden=true href=#22-repository>#</a></h2><ol><li><p>æ–°å»ºrepository</p><p><img alt=æ–°å»ºreposiroty loading=lazy src=/images/ci/repository.png></p></li><li><p>è®¾ç½®webhook</p><p>repository çš„webhookè®¾ç½®ä¸organizationçš„webhookå®Œå…¨ä¸€è‡´ã€‚</p></li><li><p>æ£€æŸ¥ä»“åº“webhookè”é€šæ€§</p><p><strong>æ³¨æ„ï¼šè¿™æ­¥éœ€è¦åœ¨Jenkinsè®¾ç½®å¥½åæ‰å¯ä»¥éªŒè¯ã€‚</strong></p><p>ç‚¹å‡» Test Deliveryï¼Œå¯ä»¥æµ‹è¯•Giteaåˆ°JenkinsæœåŠ¡æ˜¯å¦è¿é€šï¼Œæ³¨æ„éœ€è¦å…ˆå¯åŠ¨JenkinsæœåŠ¡ã€‚</p><p><img alt="Test Delivery" loading=lazy src=/images/ci/test-delivery.png></p><p>&ldquo;çº¢è‰²æ„Ÿå¹å·"ä»£è¡¨ä¸é€šï¼šæ²¡æœ‰å“åº”</p><p><img alt="Delivery Error" loading=lazy src=/images/ci/Delivery-error.png></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Delivery: Post &#34;http://10.0.0.190:8000/gitea-webhook/post&#34;: dial tcp 10.0.0.190:8000: webhook can only call allowed HTTP servers (check your webhook.ALLOWED_HOST_LIST setting), deny &#39;10.0.0.190(10.0.0.190:8000)&#39;	
</span></span></code></pre></td></tr></table></div></div></li></ol><h2 id=23-ä¿®æ”¹é…ç½®æ–‡ä»¶>2.3 ä¿®æ”¹é…ç½®æ–‡ä»¶<a hidden class=anchor aria-hidden=true href=#23-ä¿®æ”¹é…ç½®æ–‡ä»¶>#</a></h2><p>ä¿®æ”¹Giteaé…ç½®æ–‡ä»¶app.iniï¼Œæ·»åŠ å¦‚ä¸‹å†…å®¹ï¼Œå¯ä»¥ä¿®å¤2.2å°èŠ‚çš„æ­¥éª¤3å‡ºç°çš„é—®é¢˜ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[webhook]
</span></span><span class=line><span class=cl>ALLOWED_HOST_LIST = *æˆ–10.0.0.190
</span></span></code></pre></td></tr></table></div></div><h2 id=24-ç”Ÿæˆ-token>2.4 ç”Ÿæˆ Token<a hidden class=anchor aria-hidden=true href=#24-ç”Ÿæˆ-token>#</a></h2><p>è¿™ä¸ªtokenç”¨äºJenkinså¯ä»¥é€šè¿‡å®‰è£…çš„Giteaæ’ä»¶è®¿é—®Giteaï¼Œæ‰«æå’Œæ‹‰å–ä»£ç ã€‚</p><p>ç‚¹å‡»å³ä¸Šè§’ç”¨æˆ·ï¼š</p><p><img alt="Gitea Token" loading=lazy src=/images/ci/gitea-token.png></p><p>è®¾ç½®tokenåï¼Œè®¾ç½®ç›¸åº”çš„readæˆ–read/writeæƒé™ï¼Œç‚¹å‡»Generate Tokenå³å¯äº§ç”ŸTokenï¼Œå¤åˆ¶ä¸‹è¿™ä¸ªTokenï¼Œéœ€è¦æ”¾åˆ°Jenkinsçš„Cerdentialsä¸­å»ã€‚</p><p><img alt="Generate Token" loading=lazy src=/images/ci/gitea-create-token.png></p><h1 id=3-jenkins-è®¾ç½®>3. Jenkins è®¾ç½®<a hidden class=anchor aria-hidden=true href=#3-jenkins-è®¾ç½®>#</a></h1><h2 id=31-install-plugin>3.1 Install Plugin<a hidden class=anchor aria-hidden=true href=#31-install-plugin>#</a></h2><p>ç”±äºéœ€è¦ä»giteaæ‹‰å–ä»£ç ï¼Œå¹¶åˆ©ç”¨k8sæ‹‰å–é•œåƒç¼–è¯‘ä»£ç ï¼Œæ‰€ä»¥éœ€è¦å®‰è£…å¿…è¦çš„æ’ä»¶ã€‚å®‰è£… Kubernetesï¼ŒGitea.</p><p><img alt=Plugins loading=lazy src=/images/ci/plugin-install.png></p><p>åœ¨Available plugins ä¸­æœç´¢éœ€è¦å®‰è£…çš„æ’ä»¶ï¼Œç‚¹å‡»å³ä¸Šè§’çš„"Install&rdquo; å³å¯å®‰è£…ã€‚</p><p>å®‰è£…å¥½ååœ¨Install pluginså¯ä»¥æŸ¥çœ‹ï¼š</p><p><img alt="Kubernetes Plugin" loading=lazy src=/images/ci/k8s-plugin.png></p><p><img alt="Gitea plugin" loading=lazy src=/images/ci/gitea-plugin.png></p><h2 id=32-system-configuration>3.2 System Configuration<a hidden class=anchor aria-hidden=true href=#32-system-configuration>#</a></h2><p>ç‚¹å‡» Manage Jenkins->System Configuration->system:</p><p><img alt="System Configure" loading=lazy src=/images/ci/system-configure.png></p><p><img alt="Jenkins URL" loading=lazy src=/images/ci/jenkins-url.png></p><p><img alt="Gitea Server" loading=lazy src=/images/ci/gitea-server.png></p><p>Gitea Server æ·»åŠ è®¿é—®Giteaé¡µé¢çš„URLï¼Œæ·»åŠ åä¼šæ­£ç¡®æ˜¾ç¤ºGiteaçš„ç‰ˆæœ¬ã€‚è¿™ä¸ªGiteaç‰ˆæœ¬å°±æ˜¯1.24.0ã€‚</p><p>è®¾ç½®åä¿å­˜å³å¯ã€‚</p><h2 id=33-add-cerdentials>3.3 Add Cerdentials<a hidden class=anchor aria-hidden=true href=#33-add-cerdentials>#</a></h2><p>æ·»åŠ è¯ä¹¦ç”¨äºè®¿é—®Giteaå’ŒKubernetesã€‚</p><h3 id=331-æ·»åŠ gitea-credential>3.3.1 æ·»åŠ Gitea Credential<a hidden class=anchor aria-hidden=true href=#331-æ·»åŠ gitea-credential>#</a></h3><p>ç‚¹å‡» Manage Jenkins->Cerdentialsã€‚</p><p><img alt="Add Cerdentials" loading=lazy src=/images/ci/add-credentials.png></p><p>æ·»åŠ è®¿é—®Giteaçš„Credentialsï¼š</p><p>Kindé€‰æ‹©Gitea Personal Access Tokenï¼ŒTokenè¾“å…¥2.4å°èŠ‚ä¿å­˜çš„Tokenï¼ŒIDå’ŒDescription è‡ªå®šä¹‰ã€‚</p><p><img alt="Add Gitea Credentials" loading=lazy src=/images/ci/gitea-credentials.png></p><h3 id=332-æ·»åŠ -kubernetes-credential>3.3.2 æ·»åŠ  Kubernetes Credential<a hidden class=anchor aria-hidden=true href=#332-æ·»åŠ -kubernetes-credential>#</a></h3><p>æ·»åŠ Kubernetes Credentialä¸æ·»åŠ Gitea Credentialæ­¥éª¤ä¸€æ ·ï¼Œåªæ˜¯åœ¨Kindé€‰æ‹©æ—¶æœ‰æ‰€ä¸åŒï¼š</p><ol><li>Kind å¯ä»¥é€‰æ‹©Screct fileï¼Œè¿™æ˜¯åªéœ€è¦æ·»åŠ k8sçš„configæ–‡ä»¶å³å¯ã€‚æœ¬æ–‡éƒ¨ç½²çš„k8sçš„ configé…ç½®æ–‡ä»¶è·¯å¾„åœ¨masterèŠ‚ç‚¹çš„~/.kube/ä¸‹ã€‚</li></ol><p><img alt="Screct file" loading=lazy src=/images/ci/screct-file.png></p><ol start=2><li><p>Kind å¯ä»¥é€‰æ‹©Screct textï¼Œæœ¬æ–‡é‡‡ç”¨çš„è¿™ç§æ–¹å¼ã€‚</p><p>è¿™ç§æ–¹å¼éœ€è¦å…ˆè·å–K8sçš„Tokenï¼Œk8såœ¨1.24+ç‰ˆæœ¬ä¹‹åéœ€è¦æ‰‹åŠ¨ç”ŸæˆTokenï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>åˆ›å»ºå‘½åç©ºé—´devopsï¼š
</span></span><span class=line><span class=cl>kubectl create ns devops;
</span></span><span class=line><span class=cl>åˆ›å»ºæœåŠ¡è´¦å·jenkins:
</span></span><span class=line><span class=cl>kubectl create sa jenkins -n devops  #åˆ›å»ºæœåŠ¡è´¦å·jenkinså±äºå‘½åç©ºé—´devops, saæ˜¯serviceaccountsçš„ç¼©å†™
</span></span><span class=line><span class=cl>ç»‘å®šé›†ç¾¤è§’è‰²ï¼š
</span></span><span class=line><span class=cl>kubectl create clusterrolebinding jenkins --clusterrole=cluster-admin --serviceaccount=devops:jenkins
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>k8s 1.24+ä¹‹åæ‰‹åŠ¨ç”Ÿæˆtoken:
</span></span><span class=line><span class=cl>kubectl create token jenkins --duration=8760h  # æœ‰æ•ˆæœŸ 1 å¹´
</span></span></code></pre></td></tr></table></div></div></li></ol><p><strong>å¤åˆ¶kubectl create äº§ç”Ÿçš„Token</strong>ã€‚</p><p>æ·»åŠ å®Œæˆåå¯ä»¥çœ‹åˆ°ï¼š</p><p><img alt=credentials loading=lazy src=/images/ci/credentials.png></p><h2 id=34--add-clouds>3.4 Add Clouds<a hidden class=anchor aria-hidden=true href=#34--add-clouds>#</a></h2><p>é…ç½®Jenkinsé€šè¿‡Kubernetesæ’ä»¶ä¸Kubernetesè¿æ¥ã€‚</p><h3 id=341-new-cloud>3.4.1 New cloud<a hidden class=anchor aria-hidden=true href=#341-new-cloud>#</a></h3><p>ç‚¹å‡» Manage Jenkins &mdash;> Clouds&ndash;>New cloud.</p><p>è¾“å…¥cloud nameï¼ŒTypeé€‰æ‹©Kubernetesï¼Œç‚¹å‡»Createã€‚</p><p><img alt="New Cloud" loading=lazy src=/images/ci/new-cloud.png></p><h3 id=342-cloud-configure>3.4.2 Cloud Configure<a hidden class=anchor aria-hidden=true href=#342-cloud-configure>#</a></h3><p><img alt="K8s address" loading=lazy src=/images/ci/cloud-cfg.png></p><ul><li>åç§°: ç»§æ‰¿ä¸Šä¸ªæ­¥éª¤è¾“å…¥çš„ï¼›</li><li>Kubernetesåœ°å€: Kubernetesé›†ç¾¤kube-apiserveræ‰€åœ¨èŠ‚ç‚¹çš„IPå’Œç«¯å£ï¼Œå¦‚æœåœ°å€ä¸é€šä¼šæœ‰æç¤ºï¼›</li><li>ç¦ç”¨httpsæ£€æŸ¥ï¼›</li><li>Kubernetes å‘½ä»¤ç©ºé—´ï¼šè¾“å…¥3.3.2æ­¥éª¤åˆ›å»ºçš„</li></ul><p><img alt="add k8s credential" loading=lazy src=/images/ci/add-k8s-token.png></p><ul><li>å‡­æ®ï¼šé€‰æ‹©3.3.2æ­¥éª¤æ·»åŠ çš„k8s credentialsï¼›</li><li>å‹¾é€‰websocketï¼›</li><li>Jenkinsåœ°å€ï¼šå¡«å†™JenkinsæœåŠ¡çš„ä¸»æœºIPä¸æœåŠ¡ç«¯å£å·ã€‚</li></ul><p><img alt="Pod Label" loading=lazy src=/images/ci/pod-Lable.png></p><ul><li>Pod Lable: æ ‡ç­¾è‡ªå®šä¹‰ä¸€ä¸ªï¼Œåç»­åœ¨Podçš„yamlæ–‡ä»¶ä¸­èƒ½çœ‹åˆ°è¿™ä¸ªã€‚</li><li>Pod Retetionï¼šPod ä¿ç•™ç­–ç•¥ï¼Œalwaysæ˜¯æ°¸ä¹…ä¿å­˜ã€‚</li></ul><p>å…¶ä»–é»˜è®¤ï¼Œæœ€åç‚¹å‡»ä¿å­˜å³å¯ã€‚</p><h1 id=4-ä¸Šä¼ ä»£ç åˆ°gitea>4 ä¸Šä¼ ä»£ç åˆ°Gitea<a hidden class=anchor aria-hidden=true href=#4-ä¸Šä¼ ä»£ç åˆ°gitea>#</a></h1><h2 id=41-ç¼–å†™jenkinsfileæ–‡ä»¶>4.1 ç¼–å†™Jenkinsfileæ–‡ä»¶<a hidden class=anchor aria-hidden=true href=#41-ç¼–å†™jenkinsfileæ–‡ä»¶>#</a></h2><p>åŸºäºJenkins Kubernetesæ’ä»¶çš„podTemplateç¼–å†™Jenkinsfileæ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=cl><span class=n>podTemplate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=n>podRetention</span><span class=p>:</span> <span class=n>always</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>  <span class=n>containers</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=cl>    <span class=n>containerTemplate</span><span class=p>(</span>
</span></span><span class=line><span class=cl>      <span class=n>name</span><span class=p>:</span> <span class=s1>&#39;c-builder-env1&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>image</span><span class=p>:</span> <span class=s1>&#39;registry.example.com/c-builder-env1:latest&#39;</span><span class=p>,</span> <span class=o>//</span> <span class=err>æ›¿æ¢ä¸ºä½ çš„ç§æœ‰é•œåƒåœ°å€</span>
</span></span><span class=line><span class=cl>      <span class=n>ttyEnabled</span><span class=p>:</span> <span class=bp>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>command</span><span class=p>:</span> <span class=s1>&#39;cat&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>      <span class=n>imagePullSecrets</span><span class=p>:</span> <span class=s1>&#39;docker-registry-credentials&#39;</span> <span class=o>//</span> <span class=n>Jenkinsä¸­é…ç½®çš„Kubernetes</span> <span class=n>Secretåç§°</span>
</span></span><span class=line><span class=cl>    <span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=cl><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=n>node</span><span class=p>(</span><span class=n>POD_LABEL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>stage</span><span class=p>(</span><span class=s1>&#39;Checkout&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>checkout</span> <span class=n>scm</span>              <span class=o>//</span> <span class=err>ä¾èµ–</span><span class=n>Jenkinsä»»åŠ¡é…ç½®çš„SCM</span><span class=err>ï¼Œæ£€å‡ºä»£ç </span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>stage</span><span class=p>(</span><span class=s1>&#39;Build in env1&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>container</span><span class=p>(</span><span class=s1>&#39;c-builder-env1&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>withEnv</span><span class=p>([</span><span class=s1>&#39;PATH+EXTRA=/opt/build-tools&#39;</span><span class=p>])</span> <span class=p>{</span> <span class=o>//</span> <span class=err>æ›¿æ¢ä¸ºä½ çš„å·¥å…·è·¯å¾„</span>
</span></span><span class=line><span class=cl>          <span class=n>sh</span> <span class=s1>&#39;&#39;&#39;#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=s1>          set -exo pipefail
</span></span></span><span class=line><span class=cl><span class=s1>          chmod +x ./build.sh
</span></span></span><span class=line><span class=cl><span class=s1>          bash ./build.sh
</span></span></span><span class=line><span class=cl><span class=s1>          &#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>stage</span><span class=p>(</span><span class=s1>&#39;Test&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>container</span><span class=p>(</span><span class=s1>&#39;c-builder-env1&#39;</span><span class=p>)</span> <span class=p>{</span> <span class=o>//</span> <span class=err>ç¤ºä¾‹ï¼šä½¿ç”¨</span><span class=n>env1è¿è¡Œæµ‹è¯•</span>
</span></span><span class=line><span class=cl>        <span class=n>withEnv</span><span class=p>([</span><span class=s1>&#39;PATH+EXTRA=/opt/build-tools&#39;</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=n>sh</span> <span class=s1>&#39;&#39;&#39;#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=s1>          set -exo pipefail
</span></span></span><span class=line><span class=cl><span class=s1>          // æ›¿æ¢ä¸ºä½ çš„æµ‹è¯•å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š
</span></span></span><span class=line><span class=cl><span class=s1>          bash ./run-tests.sh // å‡è®¾æœ‰æµ‹è¯•è„šæœ¬
</span></span></span><span class=line><span class=cl><span class=s1>          &#39;&#39;&#39;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=42-ä¸Šä¼ æºä»£ç >4.2 ä¸Šä¼ æºä»£ç <a hidden class=anchor aria-hidden=true href=#42-ä¸Šä¼ æºä»£ç >#</a></h2><p>å°†Jenkinsfileæ–‡ä»¶å’Œæºä»£ç ä¸Šä¼ åˆ° Gitea ä»“åº“ã€‚è¿™ä¸ªå¾ˆé‡è¦ï¼Œå› ä¸ºJenkinsæ˜¯æ ¹æ®Jenkinsfileæ–‡ä»¶æ¥è¿›è¡Œæµæ°´çº¿ä½œä¸šçš„ã€‚å¹¶ä¸”è¿™ä¸ªJenkinsfileæ–‡ä»¶è¦æ”¾åœ¨æºä»£ç çš„æ ¹ç›®å½•ä¸‹ã€‚</p><p><img alt=Jenkinsfile loading=lazy src=/images/ci/jenkinsfile.png></p><h1 id=5-jenkins-new-item>5 Jenkins New Item<a hidden class=anchor aria-hidden=true href=#5-jenkins-new-item>#</a></h1><h2 id=51-æ–°å»º-organization-folder>5.1 æ–°å»º Organization Folder<a hidden class=anchor aria-hidden=true href=#51-æ–°å»º-organization-folder>#</a></h2><p><img alt="New Item" loading=lazy src=/images/ci/new-item.png></p><ul><li>Item name: è¾“å…¥Gitea ä¸Šçš„organizationåï¼Œå¤§å°å†™å¿…é¡»ä¸€è‡´ï¼›</li><li>é€‰æ‹©Organization Folder</li></ul><h2 id=52-configure>5.2 configure<a hidden class=anchor aria-hidden=true href=#52-configure>#</a></h2><p>å¯¹æ–°å»ºçš„ç»„ç»‡æ–‡ä»¶å¤¹è¿›è¡Œé…ç½®ã€‚</p><p><img alt="Organization Configure" loading=lazy src=/images/ci/organization-cfg.png></p><ul><li>Display Name: è®¾ç½®çš„organizationåï¼›</li><li>Repository Sources: é€‰æ‹© Gitea Organizationï¼Œå¹¶é…ç½®Server å’Œ Credentials</li><li>Owner: å¿…é¡»ä¸ Giteaçš„Organization ä¸€è‡´ã€‚</li></ul><p><img alt="Pipeline Jenkinsfile" loading=lazy src=/images/ci/pipeline-jenkinsfile.png></p><p>è¿™å°±æ˜¯ä¸Šæ–‡è¦æ·»åŠ Jenkinsfileçš„åŸå› ï¼Œä¸ç„¶Jenkinsæ‰«æä¸åˆ°ç»„ç»‡ä¸‹çš„ä»“åº“ã€‚</p><p>ç‚¹å‡»ä¿å­˜å³è®¾ç½®å®Œæˆã€‚</p><h1 id=6-è§¦å‘jenkins>6. è§¦å‘Jenkins<a hidden class=anchor aria-hidden=true href=#6-è§¦å‘jenkins>#</a></h1><ol><li>æ‰‹åŠ¨è§¦å‘</li></ol><p><img alt="Trigger Jenkins" loading=lazy src=/images/ci/hand-trigger.png></p><ol start=2><li><p>è‡ªåŠ¨è§¦å‘</p><p>å¯¹Giteaç»„ç»‡ä¸‹ä»“åº“çš„webhookè®¾ç½®è§¦å‘æ¡ä»¶ï¼ˆ2.1å°èŠ‚ï¼‰ï¼Œpull request å°±ä¼šè‡ªåŠ¨è§¦å‘Jenkinsè°ƒç”¨k8såˆ›å»ºPODç¼–è¯‘ã€‚</p></li><li><p>ç‚¹å‡»æŸæ¬¡ç¼–è¯‘çš„Console Outputï¼Œå¯ä»¥çœ‹åˆ°è¯¦ç»†çš„ç¼–è¯‘è¿‡ç¨‹</p><p><img alt="Console Output" loading=lazy src=/images/ci/console-output.png></p><ol start=4><li><p>k8sä¸Šè‡ªåŠ¨åˆ›å»ºçš„POD</p><p><img alt="k8s pod" loading=lazy src=/images/ci/k8s-pod.png></p><p>è¿›å…¥å®¹å™¨çš„/home/jenkins/agent/workspace/xxxä¸‹ï¼Œå³å¯çœ‹åˆ°æºä»£ç ã€‚</p></li></ol></li></ol><p>â€‹</p><h1 id=7-æ­å»ºè¿‡ç¨‹é‡åˆ°çš„é—®é¢˜>7. æ­å»ºè¿‡ç¨‹é‡åˆ°çš„é—®é¢˜<a hidden class=anchor aria-hidden=true href=#7-æ­å»ºè¿‡ç¨‹é‡åˆ°çš„é—®é¢˜>#</a></h1><h2 id=é—®é¢˜1æ²¡æœ‰è‡ªåŠ¨è§¦å‘jenkins>é—®é¢˜1ï¼šæ²¡æœ‰è‡ªåŠ¨è§¦å‘Jenkins<a hidden class=anchor aria-hidden=true href=#é—®é¢˜1æ²¡æœ‰è‡ªåŠ¨è§¦å‘jenkins>#</a></h2><p>ä»Giteaä¸Špull request åˆ†æ”¯ä»£ç åˆ°ä¸»åˆ†æ”¯ï¼Œæ²¡æœ‰æˆåŠŸè§¦å‘Jenkinsã€‚è¿™å°±æ˜¯2.2å°èŠ‚ç¬¬3æ­¥çš„é—®é¢˜ï¼Œé€šè¿‡2.3è§£å†³ã€‚</p><h2 id=é—®é¢˜2é•œåƒæ‹‰å–å¤±è´¥>é—®é¢˜2ï¼šé•œåƒæ‹‰å–å¤±è´¥<a hidden class=anchor aria-hidden=true href=#é—®é¢˜2é•œåƒæ‹‰å–å¤±è´¥>#</a></h2><p><strong>ç°è±¡ï¼š</strong></p><ol><li>ä»æœ¬åœ°é•œåƒä»“åº“æ‹‰å–spice-vdagent-ks10-builder:v1.5.1é•œåƒå¤±è´¥ï¼Œé…ç½®çš„æœ¬åœ°ç§æœ‰é•œåƒä»“åº“åœ°å€æ˜¯http://xxxxï¼Œä½†æ˜¯å´ä»https://xxxæ‹‰å–ï¼›</li><li>jenkins/inbound-agent:3309.v27b_9314fd1a_4-1é•œåƒæ‹‰å–å¤±è´¥ï¼›</li></ol><p>è¿™æ˜¯k8sçš„å®¹å™¨è¿è¡Œæ—¶containerd æ‹‰å–é•œåƒçš„åœ°å€è®¾ç½®ä¸å¯¹å¯¼è‡´ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>[PodInfo] devops/spice-vd-agent-master-3-jg7c8-6hq6d-6fh7s
</span></span><span class=line><span class=cl>	Container [jnlp] waiting [ErrImagePull] failed to pull and unpack image &#34;oci.docker.com/jenkins/inbound-agent:3309.v27b_9314fd1a_4-1&#34;: failed to resolve reference &#34;oci.docker.com/jenkins/inbound-agent:3309.v27b_9314fd1a_4-1&#34;: failed to do request: Head &#34;https://oci.docker.com/v2/jenkins/inbound-agent/manifests/3309.v27b_9314fd1a_4-1&#34;: dial tcp 192.168.1.71:443: connect: connection refused
</span></span><span class=line><span class=cl>	Container [spice-vdagent-ks10-builder] waiting [ErrImagePull] failed to pull and unpack image &#34;oci.docker.com/spice-vdagent-ks10-builder:v1.5.1&#34;: failed to resolve reference &#34;oci.docker.com/spice-vdagent-ks10-builder:v1.5.1&#34;: failed to do request: Head &#34;https://oci.docker.com/v2/spice-vdagent-ks10-builder/manifests/v1.5.1&#34;: dial tcp 192.168.1.71:443: connect: connection refused
</span></span></code></pre></td></tr></table></div></div><p>ä½¿ç”¨çš„containerdæ˜¯v2.0.0ç‰ˆæœ¬ã€‚</p><p><strong>è§£å†³åŠæ³•ï¼š</strong></p><ul><li>ä¿®æ”¹containerdçš„é…ç½®æ–‡ä»¶config.tomlã€‚é»˜è®¤ç›®å½•æ˜¯/etc/containerd/ï¼Œæ·»åŠ config_path = &ldquo;xxx&rdquo;ï¼Œæ³¨æ„æœ€åä¸€çº§ç›®å½•</li></ul><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>      [plugins.&#39;io.containerd.cri.v1.images&#39;.registry]
</span></span><span class=line><span class=cl>        config_path = &#39;/etc/containerd/certs.d&#39;       
</span></span></code></pre></td></tr></table></div></div><ul><li><p>æ–°å»ºæ–‡ä»¶ /etc/containerd/certs.d/oci.docker.com/hosts.toml</p></li><li><p>ä¿®æ”¹hosts.toml</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl># å®šä¹‰æœåŠ¡å™¨çš„åŸºåœ°å€
</span></span><span class=line><span class=cl>server = &#34;http://oci.docker.com&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>[host.&#34;http://oci.docker.com&#34;]
</span></span><span class=line><span class=cl>  # å¦‚æœä»“åº“æ˜¯ HTTP æˆ–ä½¿ç”¨è‡ªç­¾åè¯ä¹¦ï¼Œéœ€è¦è®¾ç½®è¿™ä¸ª
</span></span><span class=line><span class=cl>  skip_verify = true
</span></span><span class=line><span class=cl>  capabilities = [&#34;pull&#34;, &#34;resolve&#34;]
</span></span></code></pre></td></tr></table></div></div></li><li><p>ç”±äºæœ¬åœ°é•œåƒä»“åº“æ²¡æœ‰ä¸Šä¼  inbound-agent:3309.v27b_9314fd1a_4-1é•œåƒï¼Œæ‰€ä»¥æ‹‰å–å¤±è´¥ï¼Œé…ç½®å›½å†…æºè§£å†³</p></li><li><p>æ–°å»ºæ–‡ä»¶ /etc/containerd/certs.d/docker.io/hosts.toml</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>server = &#34;https://docker.xuanyuan.me&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl># ä¸º docker.io é…ç½®é•œåƒåŠ é€Ÿå™¨ (mirrors)
</span></span><span class=line><span class=cl>[host.&#34;https://docker.xuanyuan.me&#34;]
</span></span><span class=line><span class=cl>  capabilities = [&#34;pull&#34;, &#34;resolve&#34;]
</span></span><span class=line><span class=cl>  override_path = false             # è¿™ä¸ªå¾ˆé‡è¦ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªé•œåƒè€Œä¸æ˜¯è·¯å¾„è¦†ç›–
</span></span></code></pre></td></tr></table></div></div><p>é‡å¯containerdå®¹å™¨ã€‚</p></li></ul><p>è‡³æ­¤æ­å»ºå’Œæµ‹è¯•å®Œæˆï¼</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://qingshanxiao292311.github.io/zh/tags/jenkins/>Jenkins</a></li><li><a href=https://qingshanxiao292311.github.io/zh/tags/gitea/>Gitea</a></li><li><a href=https://qingshanxiao292311.github.io/zh/tags/k8s/>K8s</a></li></ul></footer><a class=next href=https://qingshanxiao292311.github.io/zh/posts/hugo/%E5%88%A9%E7%94%A8-hugo--github-pages-%E9%83%A8%E7%BD%B2%E5%8D%9A%E5%AE%A2/>ä¸‹ä¸€ç¯‡ï¼šåˆ©ç”¨Hugo & Github pages éƒ¨ç½²åšå®¢</a>
<a class=prev href=https://qingshanxiao292311.github.io/zh/posts/deploy/gitea-%E6%9C%AC%E5%9C%B0%E9%83%A8%E7%BD%B2/>ä¸Šä¸€ç¯‡ï¼šgitea æœ¬åœ°éƒ¨ç½²</a></article></main><footer class=footer><span>&copy; 2025 <a href=https://qingshanxiao292311.github.io/zh/>è‚–é’å±±çš„åšå®¢</a></span> Â·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="å¤åˆ¶";function s(){t.innerHTML="å·²å¤åˆ¶ï¼",setTimeout(()=>{t.innerHTML="å¤åˆ¶"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>